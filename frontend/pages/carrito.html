<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Carrito de Reservas</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <link rel="stylesheet" href="../styles/carrito.css" />
</head>
<body>
  <h1>Carrito de Reservas</h1>

  <div id="carrito-contenedor"></div>
  <div class="total" id="total-carrito">Total: ARS 0</div>

  <div id="acciones" style="text-align:center; margin-top: 20px;">
    <button id="vaciar-carrito-btn">Vaciar Carrito</button>
    <button id="confirmar-compra-btn" style="background-color: #5cb85c; margin-left: 10px;">Confirmar Compra</button>
  </div>

  <div id="overlay"></div>
  <div id="ticket">
    <h3>¡Gracias por tu compra!</h3>
    <div id="ticket-contenido"></div>
    <button id="cerrar-ticket-btn">Cerrar</button>
    <button id="descargar-pdf-btn" style="display: none;">Descargar Ticket PDF</button>
  </div>

  <script>
    // Función para obtener carrito desde localStorage (la clave que usamos en index.html es "carrito")
    function obtenerCarrito() {
      const carritoJSON = localStorage.getItem('carrito');
      return carritoJSON ? JSON.parse(carritoJSON) : [];
    }

    // Guardar carrito en localStorage
    function guardarCarrito(carrito) {
      localStorage.setItem('carrito', JSON.stringify(carrito));
    }

    // Mostrar carrito en pantalla
    function mostrarCarrito() {
      const contenedor = document.getElementById('carrito-contenedor');
      const carrito = obtenerCarrito();
      contenedor.innerHTML = '';

      if (carrito.length === 0) {
        contenedor.innerHTML = '<p>El carrito está vacío.</p>';
        document.getElementById('total-carrito').textContent = 'Total: ARS 0';
        return;
      }

      let total = 0;

      carrito.forEach((item, index) => {
        total += Number(item.precio) || 0;

        const itemDiv = document.createElement('div');
        itemDiv.classList.add('carrito-item');

        itemDiv.innerHTML = `
          <h2>${item.nombre}</h2>
          <p><strong>Descripción:</strong> ${item.descripcion}</p>
          <p><strong>Categoría:</strong> ${item.categoria}</p>
          <p><strong>Precio:</strong> ARS ${Number(item.precio).toFixed(2)}</p>
          <button data-index="${index}" class="btn-eliminar">Eliminar</button>
        `;

        contenedor.appendChild(itemDiv);
      });

      document.getElementById('total-carrito').textContent = `Total: ARS ${total.toFixed(2)}`;

      document.querySelectorAll('.btn-eliminar').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const idx = parseInt(e.target.getAttribute('data-index'));
          eliminarDelCarrito(idx);
        });
      });
    }

    // Eliminar producto del carrito por índice
    function eliminarDelCarrito(index) {
      let carrito = obtenerCarrito();
      carrito.splice(index, 1);
      guardarCarrito(carrito);
      mostrarCarrito();
    }

    // Vaciar todo el carrito
    function vaciarCarrito() {
      localStorage.removeItem('carrito');
      mostrarCarrito();
    }

    // Confirmar compra y mostrar ticket modal
    function confirmarCompra() {
      const carrito = obtenerCarrito();
      if (carrito.length === 0) {
        alert('El carrito está vacío.');
        return;
      }

      let total = 0;
      const ticketContenido = document.getElementById('ticket-contenido');
      ticketContenido.innerHTML = '';

      carrito.forEach(item => {
        total += Number(item.precio) || 0;

        ticketContenido.innerHTML += `
          <div class="ticket-item">
            <p><strong>Espacio:</strong> ${item.nombre}</p>
            <p><strong>Descripción:</strong> ${item.descripcion}</p>
            <p><strong>Categoría:</strong> ${item.categoria}</p>
            <p><strong>Precio:</strong> ARS ${Number(item.precio).toFixed(2)}</p>
          </div>
        `;
      });

      const fecha = new Date().toLocaleString();
      ticketContenido.innerHTML += `<p style="text-align: right;"><strong>Total Pagado:</strong> ARS ${total.toFixed(2)}</p>`;
      ticketContenido.innerHTML += `<p style="text-align: right;">Fecha: ${fecha}</p>`;

      document.getElementById('overlay').style.display = 'block';
      document.getElementById('ticket').style.display = 'block';
      document.getElementById('descargar-pdf-btn').style.display = 'inline-block';

      document.getElementById('carrito-contenedor').style.display = 'none';
      document.getElementById('total-carrito').style.display = 'none';
      document.getElementById('acciones').style.display = 'none';

      vaciarCarrito();
    }

    // Cerrar ticket modal
    function cerrarTicket() {
      document.getElementById('overlay').style.display = 'none';
      document.getElementById('ticket').style.display = 'none';
      location.reload(); // recarga para mostrar carrito vacío
    }

    // Descargar ticket como PDF
    function descargarPDF() {
      const element = document.getElementById('ticket');
      html2pdf().set({
        margin: 0.5,
        filename: 'ticket_reserva.pdf',
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 2 },
        jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
      }).from(element).save();
    }

    document.addEventListener('DOMContentLoaded', () => {
      mostrarCarrito();

      document.getElementById('vaciar-carrito-btn').addEventListener('click', () => {
        if (confirm('¿Seguro que quieres vaciar el carrito?')) {
          vaciarCarrito();
        }
      });

      document.getElementById('confirmar-compra-btn').addEventListener('click', confirmarCompra);
      document.getElementById('cerrar-ticket-btn').addEventListener('click', cerrarTicket);
      document.getElementById('descargar-pdf-btn').addEventListener('click', descargarPDF);
    });
  </script>
</body>
</html>